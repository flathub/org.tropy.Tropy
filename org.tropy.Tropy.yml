app-id: org.tropy.Tropy
base: org.electronjs.Electron2.BaseApp
base-version: '25.08'
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22
command: tropy

finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  # Network access
  - --share=network
  # Printing
  - --socket=cups
  # WebGL / WebGPU
  - --device=dri
  # Secrets storage
  #- --talk-name=org.freedesktop.secrets
  # Idle detection
  - --talk-name=org.gnome.Mutter.IdleMonitor
  # Needed to access project files
  - --filesystem=home
  # External drive access
  - --filesystem=/media
  - --filesystem=/run/media
  - --filesystem=/mnt
  # gvfs access
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  # Use same mouse cursors as host
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons

cleanup:
  - /include
  - /lib/*.a
  - /lib/*.la
  - /lib/pkgconfig
  - /share/pkgconfig

modules:
  - name: aom
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_DOCS=0
      - -DENABLE_TESTS=0
      - -DENABLE_TESTDATA=0
      - -DENABLE_TOOLS=0
      - -DENABLE_EXAMPLES=0
      - -DENABLE_NASM=1
      - -DENABLE_NEON=1
      - -DCONFIG_PIC=1
      - -DCONFIG_AV1_HIGHBITDEPTH=0
      - -DCONFIG_WEBM_IO=0
    sources:
      - type: archive
        url: https://storage.googleapis.com/aom-releases/libaom-3.13.1.tar.gz
        sha256: 19e45a5a7192d690565229983dad900e76b513a02306c12053fb9a262cbeca7d

  - name: openjpeg
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_CODEC=OFF
    cleanup:
      - /bin
      - /lib/openjpeg-*
    sources:
      - type: archive
        url: https://github.com/uclouvain/openjpeg/archive/v2.5.4.tar.gz
        sha256: a695fbe19c0165f295a8531b1e4e855cd94d0875d2f88ec4b61080677e27188a

  - name: libimagequant
    builddir: true
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/lovell/libimagequant/archive/v2.4.1.tar.gz
        sha256: da531249038e17f0674cef6e5d4100e43bf8cdfb4f330bc2a590bff50cd91913

  - name: libspng
    builddir: true
    buildsystem: cmake-ninja
    cleanup:
      - /lib/cmake
    sources:
      - type: archive
        url: https://github.com/randy408/libspng/archive/v0.7.4.tar.gz
        sha256: 47ec02be6c0a6323044600a9221b049f63e1953faf816903e7383d4dc4234487

  - name: libde265
    config-opts:
      - --disable-dec265
      - --disable-sherlock265
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/strukturag/libde265/releases/download/v1.0.16/libde265-1.0.16.tar.gz
        sha256: b92beb6b53c346db9a8fae968d686ab706240099cdd5aff87777362d668b0de7
  - name: libheif
    cleanup:
      - /lib/cmake
      - /share/thumbnailers
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_PLUGIN_LOADING=OFF
      - -DWITH_EXAMPLES=OFF
      - -DWITH_LIBDE265=ON
      - -DWITH_X265=OFF
    sources:
      - type: archive
        url: https://github.com/strukturag/libheif/releases/download/v1.20.2/libheif-1.20.2.tar.gz
        sha256: 68ac9084243004e0ef3633f184eeae85d615fe7e4444373a0a21cebccae9d12a

  - name: cgif
    builddir: true
    buildsystem: meson
    config-opts:
      - --buildtype=release
    sources:
      - type: archive
        url: https://github.com/dloebl/cgif/archive/refs/tags/v0.5.0.tar.gz
        sha256: d6cb312c7da2c6c9f310811aa3658120c0316ba130c48a012e7baf3698920fe9

  - name: poppler-data
    builddir: true
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-data-0.4.12.tar.gz
        sha256: c835b640a40ce357e1b83666aabd95edffa24ddddd49b8daff63adb851cdab74
  - name: poppler-glib
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_ZLIB=ON
      - -DENABLE_LIBTIFF=ON
      - -DENABLE_LIBPNG=ON
      - -DENABLE_GLIB=ON
      - -DENABLE_LIBOPENJPEG=openjpeg2
      - -DENABLE_DCTDECODER=libjpeg
      - -DENABLE_BOOST=OFF
      - -DENABLE_CPP=OFF
      - -DENABLE_UTILS=OFF
      - -DENABLE_QT5=OFF
      - -DENABLE_QT6=OFF
    cleanup:
      - /lib/girepository-1.0
      - /share/gir-1.0
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-25.10.0.tar.xz
        sha256: 6b5e9bb64dabb15787a14db1675291c7afaf9387438cc93a4fb7f6aec4ee6fe0

  - name: libvips
    builddir: true
    buildsystem: meson
    config-opts:
      - --buildtype=release
      - -Ddeprecated=false
      - -Dexamples=false
      - -Dintrospection=disabled
      - -Dmodules=disabled
      - -Dppm=false
      - -Danalyze=false
      - -Dradiance=false
    cleanup:
      - /bin/vips*
      - /share/man
    sources:
      - type: archive
        url: https://github.com/libvips/libvips/releases/download/v8.17.3/vips-8.17.3.tar.xz
        sha256: 41e9a1439cd57dcc6d4435a085e2cfe181d9da1962fa84a484f09e8b536e4b77

  - name: tropy
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node22/bin
      env:
        SHARP_FORCE_GLOBAL_LIBVIPS: 'true'
        XDG_CACHE_HOME: /run/build/tropy/flatpak-node/cache
        NPM_CONFIG_CACHE: /run/build/tropy/flatpak-node/npm-cache
        NPM_CONFIG_LOGLEVEL: info
        NPM_CONFIG_OFFLINE: 'true'
        NPM_CONFIG_AUDIT: 'false'
        NPM_CONFIG_FUND: 'false'
    sources:
      - type: archive
        url: https://github.com/tropy/tropy/archive/refs/tags/v1.17.2.tar.gz
        sha256: a14cb408ad7a6c2c87be68200d18795e9bbdf20711e223212b9f8d6fb8a22cb6
        dest: tropy
      - type: file
        url: https://www.sqlite.org/2025/sqlite-autoconf-3480000.tar.gz
        sha256: ac992f7fca3989de7ed1fe99c16363f848794c8c32a158dafd4eb927a2e02fd5
      - generated-sources.json
      - type: file
        path: tropy.sh
      - type: file
        path: 001.electron-got-checksum.patch
    subdir: tropy
    build-commands:
      - install -Dm755 ../tropy.sh /app/bin/tropy
      - |
        npm install --ignore-scripts
        node node_modules/electron/install.js
      - |
        mv ../sqlite-autoconf* node_modules/sqlite3/deps
        node scripts/rebuild.js --skip-headers -f sharp sqlite3
      - |
        patch -p 1 < ../001.electron-got-checksum.patch
      - npm run build
      - |
        cd dist/Tropy-linux-*
        install -Dm644 -t /app/share/metainfo org.tropy.Tropy.metainfo.xml
        install -Dm644 -t /app/share/applications org.tropy.Tropy.desktop
        rm -r resources/icons/hicolor/1024x1024
        mv resources/icons /app/share
        mv resources/mime /app/share
        cp -r * /app
      - install -Dm755 -t /app ../flatpak-node/libffmpeg.so
